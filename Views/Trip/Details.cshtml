@model TripViewModel
@{
    ViewData["Title"] = "Detalles del Viaje";
    var seatSelection = ViewBag.SeatSelection as SeatSelectionViewModel;
}

@functions {
    string GetSeatClass(SeatViewModel seat)
    {
        if (seat.IsOccupied) return "btn-danger";
        if (seat.IsSelected) return "btn-warning";
        return "btn-success";
    }
}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Inicio</a></li>
        <li class="breadcrumb-item"><a href="@Url.Action("Index")">Viajes</a></li>
        <li class="breadcrumb-item active">Detalles</li>
    </ol>
</nav>

<!-- Trip Header -->
<div class="card bg-primary text-white mb-4">
    <div class="card-body">
        <h1 class="h3">@Model.RouteInfo</h1>
        <div class="row">
            <div class="col-md-3">Salida: <strong>@Model.DepartureTimeFormatted</strong></div>
            <div class="col-md-3">Llegada: <strong>@Model.ArrivalTimeFormatted</strong></div>
            <div class="col-md-3">Duración: <strong>@Model.DurationFormatted</strong></div>
            <div class="col-md-3">Precio: <strong>@Model.PriceFormatted</strong></div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Trip Info -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header"><h5>Información del Viaje</h5></div>
            <div class="card-body">
                <p><strong>Bus:</strong> @Model.BusInfo</p>
                <p><strong>Capacidad:</strong> @Model.TotalSeats asientos</p>
                <p><strong>Disponibles:</strong> @Model.AvailableSeats</p>
                <p><strong>Ocupados:</strong> @Model.OccupiedSeats</p>
                
                <div class="progress mb-3">
                    <div class="progress-bar @(Model.HasAvailableSeats ? "bg-success" : "bg-danger")" 
                         style="width:@Model.PercentageOccupied%">
                        @Model.PercentageOccupiedFormatted
                    </div>
                </div>

                <div class="d-grid gap-2">
                    @if (Model.HasAvailableSeats)
                    {
                        <a href="@Url.Action("SelectSeat", "Seat", new { tripId = Model.Id })" 
                           class="btn btn-success">Seleccionar Asiento</a>
                    }
                    else
                    {
                        <button class="btn btn-secondary" disabled>Sin Disponibilidad</button>
                    }
                    <a href="@Url.Action("Index")" class="btn btn-outline-primary">Volver</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Seat Map -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Mapa de Asientos</h5>
                <small>Verde: Disponible | Rojo: Ocupado | Amarillo: Seleccionado</small>
            </div>
            <div class="card-body">
                @if (seatSelection != null && seatSelection.Seats.Any())
                {
                    <div class="text-center mb-3">
                        <div class="badge bg-secondary">Conductor</div>
                    </div>

                    <div class="row justify-content-center mb-2">
                        @{
                            var seatCount = 0;
                        }
                        @foreach (var seat in seatSelection.Seats)
                        {
                            if (seatCount > 0 && seatCount % 4 == 0)
                            {
                                @:</div><div class="row justify-content-center mb-2">
                            }
                            
                            <div class="col-auto @(seatCount % 4 == 2 ? "ms-4" : "")">
                                <button type="button" 
                                        class="btn btn-sm @GetSeatClass(seat)"
                                        data-seat-id="@seat.Id"
                                        data-seat-number="@seat.SeatNumber"
                                        data-seat-price="@seat.Price"
                                        @(seat.IsOccupied ? "disabled=\"disabled\"" : "")
                                        style="width: 50px; height: 40px; margin: 2px;">
                                    @seat.SeatNumber
                                </button>
                            </div>
                            
                            seatCount++;
                        }
                    </div>

                    <!-- Selected Seat Info -->
                    <div id="selectedSeatInfo" class="mt-3" style="display: none;">
                        <div class="alert alert-info">
                            <strong>Asiento seleccionado:</strong>
                            <span id="selectedSeatNumber"></span> - 
                            <span id="selectedSeatPrice"></span>
                            <button class="btn btn-success btn-sm ms-3" id="confirmSeatBtn">
                                Confirmar Selección
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <div class="text-center py-4">
                        <p class="text-muted">No se pudo cargar el mapa de asientos</p>
                        <button class="btn btn-primary" onclick="location.reload()">Recargar</button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>
